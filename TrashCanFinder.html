<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-app-status-bar-style" content="default" />
    <meta name="theme-color" content="#1d4ed8" id="theme-color-meta" />
    <title>SPOTLESS</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Lucide Icons (for general UI icons) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
        padding: 20px;
      }

      /* Mobile-specific improvements */
      @media (max-width: 768px) {
        body {
          padding: 6px;
        }
        .container {
          max-width: 100%;
          min-height: 90vh;
          margin: 0 !important;
          border-radius: 0.5rem !important;
          box-shadow: none !important;
          padding-top: 0 !important;
        }
        nav {
          margin-bottom: 0.25rem !important;
        }
        .flex-grow {
          padding: 0 !important;
          margin-top: 0 !important;
        }
        .tab-content {
          margin-top: 0 !important;
          padding-top: 0 !important;
        }
        .tab-content h2 {
          margin-top: 0 !important;
          padding-top: 0 !important;
        }
        .tab-content > *:first-child {
          margin-top: 0 !important;
          padding-top: 0 !important;
        }
        .tab-content > div {
          margin-bottom: 0.5rem !important;
        }
        .bg-gray-50,
        .bg-blue-50 {
          padding: 0.5rem !important;
          border-radius: 0.5rem !important;
        }
        .space-y-4 > div {
          margin-bottom: 0.5rem !important;
        }
        h3 {
          margin-bottom: 0.25rem !important;
        }
        .tab-button {
          padding: 1rem 0.5rem !important;
          font-size: 0.75rem !important;
          min-height: 60px !important;
          display: flex !important;
          flex-direction: column !important;
          align-items: center !important;
          justify-content: center !important;
          text-align: center !important;
          line-height: 1.2 !important;
          flex: 1 !important;
          min-width: 0 !important;
          gap: 0.25rem !important;
        }
        .tab-button i {
          margin-right: 0 !important;
          margin-bottom: 0.25rem !important;
          width: 1.25rem !important;
          height: 1.25rem !important;
          order: 0 !important;
        }
        .btn-primary {
          padding: 1rem 1.5rem;
          min-height: 44px; /* iOS minimum touch target */
        }
        .input-field {
          padding: 1rem;
          min-height: 44px;
        }
        #map {
          height: 300px;
        }
        .chat-message-bubble {
          max-width: 90%;
        }

        /* Reduce spacing between tabs and content on mobile */
        .flex-grow {
          padding: 0.25rem 1.25rem !important;
        }

        /* Reduce spacing for content headers */
        .tab-content h2 {
          margin-bottom: 0.5rem !important;
          margin-top: 0.25rem !important;
        }

        /* Reduce spacing between content sections */
        .tab-content > div {
          margin-bottom: 0.75rem !important;
        }

        /* Reduce padding in content sections */
        .bg-gray-50,
        .bg-blue-50 {
          padding: 1rem !important;
        }

        /* Reduce spacing in progress sections */
        .space-y-4 > div {
          margin-bottom: 0.75rem !important;
        }

        /* Reduce spacing for section headers */
        h3 {
          margin-bottom: 0.5rem !important;
        }
      }

      /* Desktop tab button layout - icon to the left of text */
      @media (min-width: 769px) {
        .tab-button {
          flex-direction: row !important;
          align-items: center !important;
          justify-content: center !important;
          text-align: left !important;
        }
        .tab-button i {
          margin-right: 0.5rem !important;
          margin-bottom: 0 !important;
          order: -1 !important;
        }
      }
      .container {
        background-color: #ffffff;
        border-radius: 1rem; /* rounded-2xl */
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
        width: 100%;
        max-width: 900px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: 80vh;
      }
      .tab-button {
        padding: 0.75rem 1.25rem;
        border-radius: 0.5rem;
        font-weight: 500;
        color: #4b5563;
        transition: all 0.2s;
        cursor: pointer;
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }
      /* Default active state for Map & Routes (blue) */
      .tab-button.active {
        color: #ffffff;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }
      /* Specific active states for other tabs */
      .tab-button.active.blue {
        background-color: #1d4ed8; /* blue-700 */
      }
      .tab-button.active.red {
        background-color: #dc2626; /* red-600 */
      }
      .tab-button.active.green {
        background-color: #10b981; /* emerald-500 */
      }
      .tab-button.active.yellow {
        background-color: #f59e0b; /* amber-500 */
      }
      .tab-button:hover:not(.active) {
        background-color: #e5e7eb;
      }

      /* Base style for primary buttons */
      .btn-primary {
        color: #ffffff;
        /* Symmetric padding for perfect centering */
        padding: 0.75rem 1.5rem; /* Symmetric horizontal padding */
        border-radius: 0.5rem;
        font-weight: 600;
        transition: background-color 0.2s, transform 0.1s;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center; /* This centers the flex content (icon and text) */
        gap: 0.5rem; /* Space between icon and text */
      }

      /* Specific color variants for primary buttons */
      .btn-primary.blue {
        background-color: #1d4ed8; /* blue-700 */
      }
      .btn-primary.blue:hover {
        background-color: #1e40af; /* blue-800 */
      }
      .btn-primary.red {
        background-color: #dc2626; /* red-600 */
      }
      .btn-primary.red:hover {
        background-color: #b91c1c; /* red-700 */
      }
      .btn-primary.green {
        background-color: #10b981; /* emerald-500 */
      }
      .btn-primary.green:hover {
        background-color: #059669; /* emerald-600 */
      }
      .btn-primary.yellow {
        background-color: #f59e0b; /* amber-500 */
      }
      .btn-primary.yellow:hover {
        background-color: #d97706; /* amber-600 */
      }
      .btn-primary.purple {
        background-color: #8b5cf6; /* violet-500 */
      }
      .btn-primary.purple:hover {
        background-color: #7c3aed; /* violet-600 */
      }

      .input-field {
        padding: 0.75rem;
        border-radius: 0.5rem;
        border: 1px solid #d1d5db;
        width: 100%;
        transition: border-color 0.2s;
      }
      .input-field:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      }
      .message-box {
        background-color: #eff6ff; /* blue-50 */
        border: 1px solid #bfdbfe; /* blue-200 */
        color: #1e40af; /* blue-800 */
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        text-align: center;
        font-weight: 500;
        opacity: 0;
        max-height: 0;
        overflow: hidden;
        transition: opacity 0.3s ease-in-out, max-height 0.3s ease-in-out,
          padding 0.3s ease-in-out;
      }
      .message-box.show {
        opacity: 1;
        max-height: 100px; /* Sufficient height to show content */
        padding: 1rem;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.5rem 1rem;
        border-radius: 9999px; /* full rounded */
        font-weight: 600;
        color: #ffffff;
        background-color: #10b981; /* emerald-500 */
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
      }
      .badge.gold {
        background-color: #f59e0b; /* amber-500 */
      }
      .badge.silver {
        background-color: #9ca3af; /* gray-400 */
      }
      .badge.bronze {
        background-color: #b45309; /* orange-700 */
      }

      /* Actual Map Styles */
      #map {
        width: 100%;
        height: 400px;
        background-color: #e0f2f7; /* light blue */
        border-radius: 0.75rem;
        margin-bottom: 1rem;
        border: 1px solid #a7d9eb;
      }
      .trash-can-marker-content {
        text-align: center;
        font-weight: bold;
        color: #dc2626; /* red-600 */
      }
      .info-window-image {
        max-width: 100px;
        max-height: 100px;
        border-radius: 0.5rem;
        margin-top: 0.5rem;
      }

      /* Specific Chat Styles */
      .chat-message-bubble {
        background-color: #e2e8f0; /* slategray-200 */
        padding: 0.75rem;
        border-radius: 0.75rem; /* rounded-xl */
        margin-bottom: 0.5rem;
        max-width: 80%;
        align-self: flex-start;
        word-wrap: break-word;
      }
      .chat-message-bubble.self {
        background-color: #bfdbfe; /* blue-200 */
        align-self: flex-end;
      }
      .chat-message-meta {
        font-size: 0.75rem; /* text-xs */
        color: #6b7280; /* gray-500 */
        margin-top: 0.25rem;
      }
      .chat-input-container {
        display: flex;
        gap: 0.5rem;
        padding: 1rem;
        border-top: 1px solid #e5e7eb;
        background-color: #f9fafb;
      }

      /* Camera/Photo Upload Styles */
      /* Removed .camera-preview-container styling as the div is removed */

      /* Modal Styles */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }
      .modal.show {
        opacity: 1;
        visibility: visible;
      }
      .modal-content {
        background-color: #ffffff;
        padding: 2rem;
        border-radius: 1rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        width: 90%;
        max-width: 400px;
        position: relative;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .modal-close-button {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6b7280;
      }
    </style>
  </head>
  <body class="p-4 sm:p-6 md:p-8">
    <div class="container">
      <div
        class="p-4 bg-gray-100 border-b border-gray-200 flex items-center justify-between rounded-t-2xl"
      >
        <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
          <i
            data-lucide="trash-2"
            class="w-6 h-6 text-blue-700"
            id="header-trash-icon"
          ></i>
          SPOTLESS
        </h1>
        <div
          id="user-info"
          class="text-sm text-gray-600 flex items-center gap-2"
        >
          <i data-lucide="user" class="w-4 h-4"></i>
          <span id="user-id-display">Guest User</span>
          <button
            id="auth-toggle-button"
            class="bg-purple-500 hover:bg-purple-600 text-white text-xs px-2 py-1 rounded-md transition-colors"
          >
            Sign In
          </button>
        </div>
      </div>

      <nav class="flex justify-around bg-white p-2 border-b border-gray-200">
        <button
          id="tab-map"
          class="tab-button active blue"
          onclick="showTab('map')"
        >
          <i data-lucide="map" class="w-5 h-5"></i>
          Map & Routes
        </button>
        <button
          id="tab-mark-can"
          class="tab-button"
          onclick="showTab('mark-can')"
        >
          <i data-lucide="plus-circle" class="w-5 h-5"></i>
          Mark Trash Can
        </button>
        <button id="tab-chat" class="tab-button" onclick="showTab('chat')">
          <i data-lucide="message-square" class="w-5 h-5"></i>
          Community Chat
        </button>
        <button
          id="tab-progress"
          class="tab-button"
          onclick="showTab('progress')"
        >
          <i data-lucide="award" class="w-5 h-5"></i>
          My Progress
        </button>
      </nav>

      <div class="flex-grow px-4 pt-1 pb-2 overflow-y-auto">
        <div id="message-box" class="message-box"></div>

        <div id="content-map" class="tab-content">
          <h2
            class="text-xl font-semibold text-gray-800 mb-1 flex items-center gap-2"
          >
            <i data-lucide="map-pin" class="w-5 h-5"></i>
            Discover Trash Cans
          </h2>
          <!-- Search and Filter Section -->
          <div class="bg-blue-50 p-4 rounded-xl mb-4 border border-blue-200">
            <h3
              class="text-md font-semibold text-blue-800 mb-2 flex items-center gap-2"
            >
              <i data-lucide="search" class="w-4 h-4"></i>
              Search & Filter
            </h3>
            <div class="space-y-2">
              <input
                type="text"
                id="trash-can-search"
                placeholder="Search trash cans by ID or address..."
                class="input-field w-full"
              />
              <div class="flex gap-2">
                <button id="filter-dropdown-btn" class="btn-primary blue flex-1">
                  <i data-lucide="filter" class="w-4 h-4"></i>
                  Filters
                  <span
                    id="active-filters-count"
                    class="ml-1 bg-white text-blue-700 text-xs px-1 rounded-full hidden"
                    >0</span
                  >
                </button>
                <button id="search-btn" class="btn-primary blue flex-1">
                  <i data-lucide="search" class="w-4 h-4"></i>
                  Search
                </button>
              </div>
            </div>
            <!-- Filter Dropdown Menu -->
            <div
              id="filter-dropdown"
              class="hidden bg-white border border-blue-200 rounded-lg shadow-lg p-3 mt-2"
            >
              <div class="text-sm font-medium text-gray-700 mb-2">
                Select Filters:
              </div>
              <div class="space-y-2">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input
                    type="checkbox"
                    id="filter-has-photo"
                    class="filter-checkbox"
                    data-filter="hasPhoto"
                  />
                  <span>üì∏ Has Photo</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input
                    type="checkbox"
                    id="filter-visited"
                    class="filter-checkbox"
                    data-filter="visited"
                  />
                  <span>‚úÖ Visited</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input
                    type="checkbox"
                    id="filter-not-visited"
                    class="filter-checkbox"
                    data-filter="notVisited"
                  />
                  <span>‚ùå Not Visited</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input
                    type="checkbox"
                    id="filter-marked-by-me"
                    class="filter-checkbox"
                    data-filter="markedByMe"
                  />
                  <span>üìç Marked by Me</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input
                    type="checkbox"
                    id="filter-has-chat"
                    class="filter-checkbox"
                    data-filter="hasChat"
                  />
                  <span>üí¨ Has Chat</span>
                </label>
              </div>
              <button
                id="apply-filters-btn"
                class="btn-primary blue w-full mt-3"
              >
                Apply Filters
              </button>
            </div>
          </div>

          <!-- Google Map div -->
          <div id="map"></div>

          <div class="bg-gray-50 p-5 rounded-xl shadow-sm">
            <h3
              class="text-lg font-semibold text-gray-700 mb-3 flex items-center gap-2"
            >
              <i data-lucide="route" class="w-5 h-5"></i>
              Plan Your Route
            </h3>
            <form id="plan-route-form" class="space-y-4">
              <div>
                <label
                  for="route-start"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >Start Point (Lat, Lon) or "My Location"</label
                >
                <input
                  type="text"
                  id="route-start"
                  placeholder="e.g., My Location or 34.0522, -118.2437"
                  class="input-field"
                  required
                />
              </div>
              <div>
                <label
                  for="route-end"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >End Point (Lat, Lon) or "Trash Can ID"</label
                >
                <input
                  type="text"
                  id="route-end"
                  placeholder="e.g., Trash Can ID: abc123 or 34.0530, -118.2400"
                  class="input-field"
                  required
                />
              </div>
              <button type="submit" class="btn-primary blue">
                <i data-lucide="map" class="w-5 h-5"></i>
                Show Route
              </button>
            </form>
            <div
              id="route-display"
              class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg text-blue-800 hidden"
            >
              <h4 class="font-semibold text-base mb-2">Route Details:</h4>
              <p id="route-details-text"></p>
            </div>
          </div>
        </div>

        <div id="content-mark-can" class="tab-content hidden">
          <h2
            class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2"
          >
            <i data-lucide="plus-circle" class="w-5 h-5"></i>
            Mark a New Trash Can
          </h2>
          <div class="bg-gray-50 p-5 rounded-xl mb-6 shadow-sm">
            <form id="mark-can-form" class="space-y-4">
              <div>
                <label
                  for="can-address"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >Address</label
                >
                <input
                  type="text"
                  id="can-address"
                  placeholder="e.g., 1600 Amphitheatre Parkway, Mountain View, CA"
                  class="input-field"
                  required
                />
              </div>
              <div>
                <label
                  for="can-desc"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >Description (e.g., near park bench)</label
                >
                <textarea
                  id="can-desc"
                  rows="2"
                  placeholder="Brief description of the trash can location"
                  class="input-field"
                  required
                ></textarea>
              </div>

              <div class="border-t border-gray-200 pt-4 mt-4">
                <h4
                  class="text-base font-semibold text-gray-700 mb-2 flex items-center gap-1"
                >
                  <i data-lucide="camera" class="w-4 h-4"></i> Add a Photo
                  (Optional)
                </h4>
                <!-- Removed camera-preview-container as requested -->
                <div class="flex gap-2 mt-3">
                  <button
                    type="button"
                    id="start-camera-btn"
                    class="btn-primary red flex-1"
                  >
                    <i data-lucide="video" class="w-5 h-5"></i> Activate Camera
                  </button>
                  <button
                    type="button"
                    id="take-photo-btn"
                    class="btn-primary red flex-1 hidden"
                    disabled
                  >
                    <i data-lucide="camera" class="w-5 h-5"></i> Take Photo
                  </button>
                  <input
                    type="file"
                    id="upload-photo-input"
                    accept="image/*"
                    class="hidden"
                  />
                  <button
                    type="button"
                    id="upload-photo-btn"
                    class="btn-primary red flex-1"
                  >
                    <i data-lucide="upload" class="w-5 h-5"></i> Upload Photo
                  </button>
                </div>
                <!-- Hidden elements for camera/photo functionality -->
                <video id="camera-feed" class="hidden" autoplay playsinline></video>
                <canvas id="photo-canvas" class="hidden"></canvas>
                <img id="photo-preview" class="hidden" alt="Photo preview" />
                <p id="camera-placeholder-text" class="hidden">
                  No camera active / No photo taken
                </p>
              </div>

              <button type="submit" class="btn-primary red w-full mt-4">
                <i data-lucide="check-circle" class="w-5 h-5"></i>
                Mark Trash Can
              </button>
            </form>
          </div>
        </div>

        <div id="content-chat" class="tab-content hidden h-full flex flex-col">
          <h2
            class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2"
          >
            <i data-lucide="messages-square" class="w-5 h-5"></i>
            Community Chat Board
          </h2>
          <div
            id="general-chat-messages"
            class="flex-grow bg-gray-50 p-4 rounded-xl overflow-y-auto mb-4 border border-gray-200 flex flex-col items-start"
            style="min-height: 300px"
          >
            <p class="text-gray-500 text-sm italic">
              No messages yet. Be the first to say hello!
            </p>
          </div>
          <div class="chat-input-container">
            <input
              type="text"
              id="general-chat-input"
              placeholder="Type your message here..."
              class="input-field flex-grow"
            />
            <button id="send-general-message-btn" class="btn-primary green flex-shrink-0">
              <i data-lucide="send" class="w-5 h-5"></i>
              Send
            </button>
          </div>

          <div id="specific-chat-section" class="mt-6 hidden">
            <h3
              class="text-lg font-semibold text-gray-700 mb-3 flex items-center gap-2"
            >
              <i data-lucide="message-circle" class="w-5 h-5"></i>
              Chat for Trash Can:
              <span id="specific-chat-can-id" class="font-bold"></span>
            </h3>
            <div
              id="specific-chat-messages"
              class="bg-gray-50 p-4 rounded-xl overflow-y-auto mb-4 border border-gray-200 flex flex-col items-start"
              style="min-height: 200px"
            >
              <p class="text-gray-500 text-sm italic">
                Select a trash can from the map to view its specific chat.
              </p>
            </div>
            <div class="chat-input-container">
              <input
                type="text"
                id="specific-chat-input"
                placeholder="Type your message for this trash can..."
                class="input-field flex-grow"
              />
              <button
                id="send-specific-message-btn"
                class="btn-primary green flex-shrink-0"
              >
                <i data-lucide="send" class="w-5 h-5"></i>
                Send
              </button>
            </div>
          </div>
        </div>

        <div id="content-progress" class="tab-content hidden">
          <h2
            class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2"
          >
            <i data-lucide="activity" class="w-5 h-5"></i>
            Your Activity & Achievements
          </h2>
          <div class="bg-gray-50 p-5 rounded-xl shadow-sm space-y-4">
            <div>
              <h3
                class="text-lg font-semibold text-gray-700 mb-2 flex items-center gap-2"
              >
                <i data-lucide="compass" class="w-5 h-5"></i>
                Walking Metrics
              </h3>
              <p class="text-gray-600">
                Total Distance Walked:
                <span id="total-distance" class="font-bold text-blue-700"
                  >0 km</span
                >
              </p>
              <p class="text-gray-600">
                Unique Trash Cans Visited:
                <span id="visited-cans-count" class="font-bold text-blue-700"
                  >0</span
                >
              </p>
              <p class="text-gray-600">
                New Trash Cans Marked:
                <span id="marked-cans-count" class="font-bold text-blue-700"
                  >0</span
                >
              </p>
            </div>
            <div>
              <h3
                class="text-lg font-semibold text-gray-700 mb-2 flex items-center gap-2"
              >
                <i data-lucide="medal" class="w-5 h-5"></i>
                Your Badges
              </h3>
              <div id="badges-display" class="flex flex-wrap gap-2">
                <p class="text-gray-500 italic">
                  No badges earned yet. Keep exploring!
                </p>
              </div>
            </div>
            <div>
              <h3
                class="text-lg font-semibold text-gray-700 mb-2 flex items-center gap-2"
              >
                <i data-lucide="trophy" class="w-5 h-5"></i>
                Milestones
              </h3>
              <ul class="list-disc list-inside text-gray-600">
                <li>"New Trash Cans Visited" (3 unique cans)</li>
                <li>"Trash Can Most Frequented" (Visit any can 5 times)</li>
                <li>"New Trash Cans Marked" (Mark 1 new can)</li>
              </ul>
            </div>

            <!-- New: Your Data & Preferences Section -->
            <div class="border-t border-gray-200 pt-4 mt-4">
              <h3
                class="text-lg font-semibold text-gray-700 mb-2 flex items-center gap-2"
              >
                <i data-lucide="settings" class="w-5 h-5"></i>
                Your Data & Preferences
              </h3>
              <div class="space-y-3">
                <div>
                  <h4 class="font-medium text-gray-700 mb-1">Recent Searches:</h4>
                  <ul id="recent-searches-list" class="list-disc list-inside text-gray-600 ml-4">
                    <p class="text-gray-500 italic text-sm">No recent searches.</p>
                  </ul>
                </div>
                <div>
                  <h4 class="font-medium text-gray-700 mb-1">Favorite Locations:</h4>
                  <ul id="favorite-locations-list" class="list-disc list-inside text-gray-600 ml-4">
                    <p class="text-gray-500 italic text-sm">No favorite locations.</p>
                  </ul>
                </div>
                <div>
                  <h4 class="font-medium text-gray-700 mb-1">Recent Routes:</h4>
                  <ul id="recent-routes-list" class="list-disc list-inside text-gray-600 ml-4">
                    <p class="text-gray-500 italic text-sm">No recent routes.</p>
                  </ul>
                </div>
                <div class="border-t border-gray-100 pt-3">
                  <h4 class="font-medium text-gray-700 mb-2">Settings:</h4>
                  <div class="space-y-2">
                    <div>
                      <label for="preferred-units" class="block text-sm font-medium text-gray-700 mb-1">Preferred Units:</label>
                      <select id="preferred-units" class="input-field w-auto">
                        <option value="km">Kilometers (km)</option>
                        <option value="mi">Miles (mi)</option>
                      </select>
                    </div>
                    <div>
                      <label for="default-map-zoom" class="block text-sm font-medium text-gray-700 mb-1">Default Map Zoom:</label>
                      <input type="number" id="default-map-zoom" min="1" max="20" class="input-field w-auto" value="12">
                    </div>
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="checkbox" id="notifications-enabled" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                      <span class="text-sm font-medium text-gray-700">Enable Notifications</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Authentication Modal -->
    <div id="auth-modal" class="modal">
      <div class="modal-content">
        <button class="modal-close-button" id="close-auth-modal">&times;</button>
        <h3 class="text-xl font-semibold text-gray-800 mb-4">
          Sign In or Sign Up
        </h3>
        <div class="space-y-4"> <!-- Added a div for spacing -->
            <div>
                <label for="auth-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input
                    type="email"
                    id="auth-email"
                    placeholder="Enter your email"
                    class="input-field"
                />
            </div>
            <div>
                <label for="auth-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                <input
                    type="password"
                    id="auth-password"
                    placeholder="Enter your password"
                    class="input-field"
                />
            </div>
        </div>
        <div class="flex gap-4 mt-2">
          <button id="auth-signin-btn" class="btn-primary flex-1 purple">
            Sign In
          </button>
          <button id="auth-signup-btn" class="btn-primary flex-1 purple">
            Sign Up
          </button>
        </div>
        <div id="auth-message" class="text-sm text-center text-red-500 hidden"></div>
      </div>
    </div>

    <!-- Google Maps API Script -->
    <script
      src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap"
      async
      defer
    ></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        addDoc,
        setDoc,
        updateDoc,
        onSnapshot,
        collection,
        query,
        where,
        arrayUnion,
        arrayRemove,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // Initialize Firebase variables (provided by Canvas environment)
      const appId = typeof __app_id !== "undefined" ? __app_id : "default-app-id";
      const firebaseConfig =
        typeof __firebase_config !== "undefined"
          ? JSON.parse(__firebase_config)
          : {};

      let app;
      let db;
      let auth;
      let userId = "";
      let userDisplayName = "Guest User";
      let currentUserData = null;

      // Global map variables
      let map;
      let mapInitialized = false; // Flag to track map initialization
      let mapMarkers = {}; // Store Google Maps Marker objects by trash can ID
      let mapPolylines = []; // Store Google Maps Polyline objects for routes
      let infoWindow; // Global info window for markers
      let geocoder; // Google Maps Geocoder service

      // Camera/Photo variables
      let mediaStream = null;
      let capturedPhotoBase64 = null;

      // Data arrays to hold real-time data
      let trashCans = [];
      let generalChatMessages = [];
      let specificChatMessages = [];
      let currentSelectedCanId = null;
      let currentFilters = {}; // Store active filters

      // Get Auth Modal Elements
      const authModal = document.getElementById("auth-modal");
      const closeAuthModalBtn = document.getElementById("close-auth-modal");
      const authEmailInput = document.getElementById("auth-email");
      const authPasswordInput = document.getElementById("auth-password");
      const authSignInBtn = document.getElementById("auth-signin-btn");
      const authSignUpBtn = document.getElementById("auth-signup-btn");
      const authMessageDiv = document.getElementById("auth-message");
      const authToggleButton = document.getElementById("auth-toggle-button"); // Renamed from signin-button

      // Get Filter Elements
      const filterDropdownBtn = document.getElementById("filter-dropdown-btn");
      const filterDropdown = document.getElementById("filter-dropdown");
      const filterCheckboxes = document.querySelectorAll(".filter-checkbox");
      const applyFiltersBtn = document.getElementById("apply-filters-btn");
      const activeFiltersCountSpan = document.getElementById(
        "active-filters-count"
      );
      const trashCanSearchInput = document.getElementById("trash-can-search");
      const searchBtn = document.getElementById("search-btn");

      // Get Progress Page Settings Elements
      const preferredUnitsSelect = document.getElementById('preferred-units');
      const defaultMapZoomInput = document.getElementById('default-map-zoom');
      const notificationsEnabledCheckbox = document.getElementById('notifications-enabled');
      const recentSearchesList = document.getElementById('recent-searches-list');
      const favoriteLocationsList = document.getElementById('favorite-locations-list');
      const recentRoutesList = document.getElementById('recent-routes-list');


      // Helper function to show messages in the main app message box
      function showMessage(message, type = "info") {
        const msgBox = document.getElementById("message-box");
        msgBox.textContent = message;
        msgBox.className = "message-box show"; // Reset and add show class
        if (type === "error") {
          msgBox.classList.add("bg-red-100", "border-red-400", "text-red-700");
        } else if (type === "success") {
          msgBox.classList.add(
            "bg-green-100",
            "border-green-400",
            "text-green-700"
          );
        } else {
          msgBox.classList.add(
            "bg-blue-100",
            "border-blue-400",
            "text-blue-700"
          );
        }
        // Hide after 5 seconds
        setTimeout(() => {
          msgBox.classList.remove("show");
          // Remove specific color classes after fade out
          setTimeout(() => {
            msgBox.className = "message-box"; // Reset to base
          }, 300);
        }, 5000);
      }

      // Helper function to show messages specifically within the auth modal
      function showAuthMessage(message, type = "error") {
        authMessageDiv.textContent = message;
        authMessageDiv.classList.remove("hidden", "text-red-500", "text-green-500");
        if (type === "error") {
          authMessageDiv.classList.add("text-red-500");
        } else {
          authMessageDiv.classList.add("text-green-500");
        }
      }

      // Function to open the auth modal
      function openAuthModal() {
        authModal.classList.add("show");
        authMessageDiv.classList.add("hidden"); // Clear previous messages
        authEmailInput.value = "";
        authPasswordInput.value = "";
      }

      // Function to close the auth modal
      function closeAuthModal() {
        authModal.classList.remove("show");
      }

      // Function to sign out the user
      async function signOutUser() {
        try {
          await signOut(auth);
          // The onAuthStateChanged listener will handle UI updates
          showMessage("Signed out successfully!", "success");
        } catch (error) {
          console.error("Error signing out:", error);
          showMessage(`Failed to sign out: ${error.message}`, "error");
        }
      }

      // Initialize Firebase and Authentication
      async function initializeFirebaseApp() {
        try {
          // Check if projectId is provided in firebaseConfig
          if (!firebaseConfig.projectId || firebaseConfig.projectId === "your-project-id") {
              showMessage(
                  "Firebase projectId is not configured. Please open 'firebase-config.js' and replace 'your-project-id' with your actual Firebase project ID to enable full app functionality.",
                  "error"
              );
              // Set the auth toggle button to open the modal directly if config is missing
              authToggleButton.textContent = "Sign In";
              authToggleButton.onclick = openAuthModal;
              return; // Stop further Firebase initialization
          }

          app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);

          // This listener runs whenever the user's sign-in state changes.
          onAuthStateChanged(auth, async (user) => {
            if (user) {
              userId = user.uid;
              // Determine user display name
              userDisplayName = user.email || `User: ${userId.substring(0, 8)}... (Guest)`;

              const userDocRef = doc(
                db,
                `artifacts/${appId}/users/${userId}/profile`,
                "data"
              );
              const userDocSnap = await getDoc(userDocRef);
              if (!userDocSnap.exists()) {
                await setDoc(userDocRef, {
                  displayName: userDisplayName,
                  totalDistanceWalked: 0,
                  visitedTrashCans: [],
                  markedTrashCans: [],
                  frequentedTrashCans: {},
                  badges: [],
                  recentSearches: [], // New field
                  favoriteLocations: [], // New field
                  recentRoutes: [], // New field
                  preferredUnits: 'km', // New field
                  defaultMapZoom: 12, // New field
                  notificationsEnabled: true, // New field
                  createdAt: serverTimestamp()
                });
                showMessage("New user profile created!", "success");
              } else {
                const userData = userDocSnap.data();
                if (userData.displayName && userData.displayName !== "Guest User") {
                  userDisplayName = userData.displayName;
                }
              }

              document.getElementById("user-id-display").textContent = userDisplayName;
              authToggleButton.textContent = "Sign Out";
              authToggleButton.onclick = signOutUser; // Change button to sign out
              // Ensure it's purple for signed-in state
              authToggleButton.classList.remove("bg-blue-500", "hover:bg-blue-600", "bg-red-500", "hover:bg-red-600");
              authToggleButton.classList.add("bg-purple-500", "hover:bg-purple-600");

              setupFirestoreListeners();
              closeAuthModal();
              showMessage(`Welcome, ${userDisplayName}!`, "success");

            } else {
              // No user signed in or signed out
              userId = "";
              userDisplayName = "Guest User";
              document.getElementById("user-id-display").textContent = userDisplayName;
              authToggleButton.textContent = "Sign In";
              authToggleButton.onclick = openAuthModal; // Change button to sign in
              // Ensure it's purple for signed-out state
              authToggleButton.classList.remove("bg-red-500", "hover:bg-red-600", "bg-blue-500", "hover:bg-blue-600");
              authToggleButton.classList.add("bg-purple-500", "hover:bg-purple-600");

              console.log("No user signed in. Displaying 'Sign In' option.");

              // Attempt initial sign-in logic only if no user is currently authenticated
              // and it's the very first time this listener runs in this session.
              // This prevents endless loops if custom token is invalid or no internet.
              const initialAuthAttemptedKey = "initialAuthAttempted_" + appId;
              if (!sessionStorage.getItem(initialAuthAttemptedKey)) {
                try {
                  if (typeof __initial_auth_token !== "undefined" && __initial_auth_token) {
                    console.log("Attempting secure sign-in with custom token...");
                    await signInWithCustomToken(auth, __initial_auth_token);
                    showMessage("Signed in securely!", "success");
                  } else {
                    console.log("No custom token provided. Attempting anonymous sign-in...");
                    await signInAnonymously(auth);
                    showMessage("Signed in anonymously!", "info");
                  }
                } catch (error) {
                  console.error("Initial sign-in attempt failed:", error);
                  if (
                    error.code === "auth/invalid-custom-token" ||
                    error.code === "auth/invalid-claims"
                  ) {
                    console.log(
                      "Custom token invalid. Attempting anonymous sign-in as fallback..."
                    );
                    try {
                      await signInAnonymously(auth);
                      showMessage(
                        "Secure login failed (invalid token). Signed in anonymously.",
                        "info"
                      );
                    } catch (anonError) {
                      console.error("Anonymous sign-in fallback failed:", anonError);
                      showMessage(
                        'Failed to sign in. Please check your network or use "Sign In" to register.',
                        "error"
                      );
                    }
                  } else {
                    showMessage(
                      `Initial sign-in failed: ${error.message}. Please use "Sign In" to register.`,
                      "error"
                    );
                  }
                } finally {
                  // Mark that an initial authentication attempt has been made for this session.
                  sessionStorage.setItem(initialAuthAttemptedKey, "true");
                }
              }
            }
            // Ensure the map tab is shown and icons are created after auth state is resolved
            showTab("map"); // Ensure initial tab is always set
          });

        } catch (initializationError) {
          console.error("Error initializing Firebase:", initializationError);
          showMessage(
            `Fatal Error: ${initializationError.message}. Please check Firebase config.`,
            "error"
          );
        }
      }

      // Event listener for the header Auth Toggle button
      authToggleButton.addEventListener("click", () => {
        // This listener will be overridden by the onAuthStateChanged for signed in/out states.
        // If it still fires here, it means no user is logged in, so open modal.
        if (!auth.currentUser) {
          openAuthModal();
        } else {
          signOutUser();
        }
      });
      closeAuthModalBtn.addEventListener("click", closeAuthModal);

      // Handle Email/Password Sign Up
      authSignUpBtn.addEventListener("click", async () => {
        const email = authEmailInput.value;
        const password = authPasswordInput.value;

        if (!email || !password) {
          showAuthMessage("Please enter both email and password.");
          return;
        }

        try {
          const userCredential = await createUserWithEmailAndPassword(
            auth,
            email,
            password
          );
          // User is automatically signed in upon creation
          showAuthMessage("Account created and signed in!", "success");
          // The onAuthStateChanged listener will handle UI update and profile creation
        } catch (error) {
          console.error("Sign Up failed:", error);
          let errorMessage = "Sign Up failed.";
          if (error.code === "auth/email-already-in-use") {
            errorMessage = "Email already in use. Try signing in.";
          } else if (error.code === "auth/weak-password") {
            errorMessage = "Password is too weak (min 6 characters).";
          } else if (error.code === "auth/invalid-email") {
            errorMessage = "Invalid email address.";
          }
          showAuthMessage(errorMessage, "error");
        }
      });

      // Handle Email/Password Sign In
      authSignInBtn.addEventListener("click", async () => {
        const email = authEmailInput.value;
        const password = authPasswordInput.value;

        if (!email || !password) {
          showAuthMessage("Please enter both email and password.");
          return;
        }

        try {
          const userCredential = await signInWithEmailAndPassword(
            auth,
            email,
            password
          );
          showAuthMessage("Signed in successfully!", "success");
          // The onAuthStateChanged listener will handle UI update
        } catch (error) {
          console.error("Sign In failed:", error);
          let errorMessage = "Sign In failed.";
          if (
            error.code === "auth/user-not-found" ||
            error.code === "auth/wrong-password" ||
            error.code === "auth/invalid-credential"
          ) {
            errorMessage = "Invalid email or password.";
          } else if (error.code === "auth/invalid-email") {
            errorMessage = "Invalid email address format.";
          }
          showAuthMessage(errorMessage, "error");
        }
      });

      // Global function for Google Maps callback
      window.initMap = function () {
        // Use defaultMapZoom from user data if available, otherwise 12
        const initialZoom = currentUserData?.defaultMapZoom || 12;
        // Default center: Los Angeles (example)
        const defaultCenter = { lat: 34.0522, lng: -118.2437 };
        map = new google.maps.Map(document.getElementById("map"), {
          center: defaultCenter,
          zoom: initialZoom,
          mapTypeControl: false,
          streetViewControl: false,
          fullscreenControl: false,
        });

        infoWindow = new google.maps.InfoWindow();
        geocoder = new google.maps.Geocoder(); // Initialize Geocoder

        // Add listener for clicks on the map to get coordinates
        map.addListener("click", (mapsMouseEvent) => {
          const lat = mapsMouseEvent.latLng.lat();
          const lon = mapsMouseEvent.latLng.lng();
          showMessage(
            `Map clicked at: Lat ${lat.toFixed(6)}, Lon ${lon.toFixed(
              6
            )}. You can use these for route planning or marking a can.`,
            "info"
          );
        });
        mapInitialized = true; // Set flag to true once map is ready
        console.log("Google Map initialized.");
        // After map is initialized, if the map tab is active, display trash cans
        if (document.getElementById('content-map').classList.contains('hidden') === false) {
            applyAndDisplayFilters(); // Re-apply filters to ensure markers are drawn on the now-ready map
        }
      };

      // Set up real-time Firestore listeners
      function setupFirestoreListeners() {
        // Listen for trash cans
        const trashCansColRef = collection(
          db,
          `artifacts/${appId}/public/data/trash_cans`
        );
        onSnapshot(
          trashCansColRef,
          (snapshot) => {
            trashCans = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            applyAndDisplayFilters(); // Apply filters after data fetch
            console.log("Trash cans updated:", trashCans);
          },
          (error) => {
            console.error("Error fetching trash cans:", error);
            // Provide user-friendly message for permission errors
            if (error.code === "permission-denied") {
              showMessage(
                "Error loading trash cans: Missing or insufficient Firestore permissions. Please check your Firebase Security Rules.",
                "error"
              );
            } else {
              showMessage(`Error loading trash cans: ${error.message}`, "error");
            }
          }
        );

        // Listen for general chat messages
        const generalChatColRef = collection(
          db,
          `artifacts/${appId}/public/data/general_chat`
        );
        const generalChatQuery = query(generalChatColRef);
        onSnapshot(
          generalChatQuery,
          (snapshot) => {
            generalChatMessages = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            displayChatMessages("general");
            console.log("General chat updated:", generalChatMessages);
          },
          (error) => {
            console.error("Error fetching general chat:", error);
            if (error.code === "permission-denied") {
              showMessage(
                "Error loading general chat: Missing or insufficient Firestore permissions. Please check your Firebase Security Rules.",
                "error"
              );
            } else {
              showMessage(`Error loading general chat: ${error.message}`, "error");
            }
          }
        );

        // Listen for current user's data
        const userDocRef = doc(
          db,
          `artifacts/${appId}/users/${userId}/profile`,
          "data"
        );
        onSnapshot(
          userDocRef,
          (docSnap) => {
            if (docSnap.exists()) {
              currentUserData = docSnap.data();
              displayUserProgress();
              checkAndAwardBadges();
              updateSettingsUI(); // Update UI with fetched settings
              console.log("User data updated:", currentUserData);
              // Re-apply filters as user data (visited/marked) might have changed
              applyAndDisplayFilters();
            } else {
              console.log("Current user document does not exist yet.");
            }
          },
          (error) => {
            console.error("Error fetching user data:", error);
            if (error.code === "permission-denied") {
              showMessage(
                "Error loading user data: Missing or insufficient Firestore permissions. Please check your Firebase Security Rules.",
                "error"
              );
            } else {
              showMessage(`Error loading user data: ${error.message}`, "error");
            }
          }
        );
      }

      // Function to display chat messages for a given type (general or specific)
      function displayChatMessages(type) {
        const chatMessagesContainer =
          type === "general"
            ? document.getElementById("general-chat-messages")
            : document.getElementById("specific-chat-messages");
        const messages = type === "general" ? generalChatMessages : specificChatMessages;

        chatMessagesContainer.innerHTML = ""; // Clear previous messages

        if (messages.length === 0) {
          chatMessagesContainer.innerHTML = `<p class="text-gray-500 text-sm italic">No messages yet. Be the first to say hello!</p>`;
          return;
        }

        // Sort messages by timestamp if available (ascending)
        messages.sort((a, b) => (a.timestamp?.toDate() || 0) - (b.timestamp?.toDate() || 0));

        messages.forEach((msg) => {
          const isSelf = msg.userId === userId;
          const messageBubble = document.createElement("div");
          messageBubble.className = `chat-message-bubble ${
            isSelf ? "self" : ""
          }`;

          const userName = document.createElement("div");
          userName.className = "font-semibold text-sm mb-1";
          userName.textContent = msg.userDisplayName || "Unknown User";

          const messageText = document.createElement("div");
          messageText.textContent = msg.message;

          const timestampText = document.createElement("div");
          timestampText.className = "chat-message-meta";
          if (msg.timestamp) {
            const date = msg.timestamp.toDate();
            timestampText.textContent = date.toLocaleString();
          } else {
            timestampText.textContent = "Just now";
          }

          messageBubble.appendChild(userName);
          messageBubble.appendChild(messageText);
          messageBubble.appendChild(timestampText);

          chatMessagesContainer.appendChild(messageBubble);
        });

        // Scroll to bottom
        chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
      }

      // Function to display trash cans on the actual Google Map
      function displayTrashCansOnMap(filteredCans = trashCans) {
        if (!mapInitialized || !map) { // Ensure map is initialized before proceeding
            console.warn("Attempted to display trash cans before map was initialized.");
            return;
        }
        // Clear existing markers
        for (const canId in mapMarkers) {
          mapMarkers[canId].setMap(null); // Remove marker from map
        }
        mapMarkers = {}; // Reset markers object

        if (filteredCans.length === 0) {
          // If no trash cans after filtering, center on default location
          map.setCenter({ lat: 34.0522, lng: -118.2437 }); // Default center (e.g., LA)
          map.setZoom(currentUserData?.defaultMapZoom || 12); // Use user's default zoom
          return;
        }

        filteredCans.forEach((can) => {
          const position = { lat: can.latitude, lng: can.longitude };
          const marker = new google.maps.Marker({
            position: position,
            map: map,
            icon: {
              url: "https://maps.google.com/mapfiles/ms/icons/red-dot.png", // Red dot icon
              scaledSize: new google.maps.Size(32, 32),
            },
            title: can.description || "Trash Can",
          });

          let infoContent = `
            <div class="trash-can-marker-content">
                <strong>Trash Can ID:</strong> ${can.id.substring(0, 8)}...<br>
                <strong>Description:</strong> ${can.description || "N/A"}<br>
                <strong>Marked by:</strong> ${
                  can.markedByUserDisplayName || "Unknown"
                }<br>
          `;
          if (can.imageUrl) {
            infoContent += `<img src="${can.imageUrl}" alt="Trash Can Photo" class="info-window-image">`;
          }
          infoContent += `<br>
            <div class="flex flex-col gap-2 mt-2">
                <button onclick="window.selectTrashCanForChat('${can.id}')" class="btn-primary p-2 text-sm rounded-md blue">View Chat</button>
                <button onclick="window.addFavoriteLocation('${can.id}', '${can.description || 'Trash Can'}')" class="btn-primary p-2 text-sm rounded-md yellow">Favorite</button>
            </div>
          </div>`;

          marker.addListener("click", () => {
            infoWindow.setContent(infoContent);
            infoWindow.open(map, marker);
            trackVisitedCan(can.id);
          });

          mapMarkers[can.id] = marker;
        });

        // Fit map to filtered bounds
        if (filteredCans.length > 0) {
          const bounds = new google.maps.LatLngBounds();
          filteredCans.forEach((can) =>
            bounds.extend({ lat: can.latitude, lng: can.longitude })
          );
          map.fitBounds(bounds);
          map.setZoom(Math.min(map.getZoom(), currentUserData?.defaultMapZoom || 15)); // Adjust zoom level, use user's default zoom
        }
      }

      // --- Filter and Search Logic ---
      filterDropdownBtn.addEventListener("click", () => {
        filterDropdown.classList.toggle("hidden");
      });

      applyFiltersBtn.addEventListener("click", () => {
        applyAndDisplayFilters();
        filterDropdown.classList.add("hidden"); // Hide dropdown after applying
      });

      searchBtn.addEventListener("click", applyAndDisplayFilters); // Trigger filter/search on search button click
      trashCanSearchInput.addEventListener("keypress", (event) => {
        if (event.key === "Enter") {
          applyAndDisplayFilters();
        }
      });

      function applyAndDisplayFilters() {
        const searchTerm = trashCanSearchInput.value.toLowerCase().trim();
        let activeFilterCount = 0;

        // Update currentFilters based on checkbox states
        filterCheckboxes.forEach((checkbox) => {
          currentFilters[checkbox.dataset.filter] = checkbox.checked;
          if (checkbox.checked) {
            activeFilterCount++;
          }
        });

        // Update filter count display
        if (activeFilterCount > 0) {
          activeFiltersCountSpan.textContent = activeFilterCount;
          activeFiltersCountSpan.classList.remove("hidden");
        } else {
          activeFiltersCountSpan.classList.add("hidden");
        }

        const filteredCans = trashCans.filter((can) => {
          const matchesSearch =
            !searchTerm ||
            can.id.toLowerCase().includes(searchTerm) ||
            can.address.toLowerCase().includes(searchTerm) ||
            can.description.toLowerCase().includes(searchTerm) ||
            (can.markedByUserDisplayName && can.markedByUserDisplayName.toLowerCase().includes(searchTerm));

          let matchesFilters = true;

          if (currentFilters.hasPhoto && !can.imageUrl) {
            matchesFilters = false;
          }
          // Check if currentUserData and visitedTrashCans exist before using .includes
          if (currentFilters.visited && !(currentUserData?.visitedTrashCans || []).includes(can.id)) {
            matchesFilters = false;
          }
          if (currentFilters.notVisited && (currentUserData?.visitedTrashCans || []).includes(can.id)) {
            matchesFilters = false;
          }
          if (currentFilters.markedByMe && can.markedByUserId !== userId) {
            matchesFilters = false;
          }
          // Placeholder for hasChat filter - requires backend support to be accurate
          if (currentFilters.hasChat) {
            // This filter is currently a placeholder and will always return true.
            // A real implementation would require a field on the trash can document
            // indicating if it has chat messages, or a server-side query.
             matchesFilters = true;
          }


          return matchesSearch && matchesFilters;
        });

        if (mapInitialized && map) { // Only call displayTrashCansOnMap if map is ready
            displayTrashCansOnMap(filteredCans);
        } else {
            console.warn("Map not yet initialized when applying filters. Markers will appear once map is ready.");
        }

        // Save recent search term to user data
        if (searchTerm && userId) {
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'data');
            const updatedSearches = [searchTerm, ...(currentUserData?.recentSearches || [])].slice(0, 5); // Keep last 5
            updateDoc(userDocRef, { recentSearches: updatedSearches }).catch(console.error);
        }
      }


      // Handle marking a new trash can
      document.getElementById("mark-can-form").addEventListener("submit", async (event) => {
          event.preventDefault();
          const address = document.getElementById("can-address").value.trim();
          const desc = document.getElementById("can-desc").trim();

          if (!address) {
              showMessage("Please enter an address.", "error");
              return;
          }
          if (!desc) {
              showMessage("Please enter a description.", "error");
              return;
          }

          // Geocode the address to get latitude and longitude using Google Maps Geocoder
          geocoder.geocode({ 'address': address }, async (results, status) => {
              if (status === 'OK' && results[0]) {
                  const lat = results[0].geometry.location.lat();
                  const lon = results[0].geometry.location.lng();

                  if (!capturedPhotoBase64) {
                      showMessage("No photo provided, marking trash can without an image.", "info");
                  }

                  try {
                      await addDoc(collection(db, `artifacts/${appId}/public/data/trash_cans`), {
                          latitude: lat,
                          longitude: lon,
                          address: address, // Store the address too
                          description: desc,
                          markedByUserId: userId,
                          markedByUserDisplayName: userDisplayName,
                          imageUrl: capturedPhotoBase64 || null, // Store Base64 image
                          createdAt: serverTimestamp()
                      });

                      // Update user's marked cans count
                      const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'data');
                      await updateDoc(userDocRef, {
                          markedTrashCans: arrayUnion(userId + '_' + Date.now()) // Unique ID for each marked action
                      });

                      showMessage("Trash can marked successfully!", "success");
                      document.getElementById("mark-can-form").reset();
                      // Reset camera/photo preview
                      resetCameraAndPhotoPreview();
                  } catch (error) {
                      console.error("Error marking trash can:", error);
                      if (error.code === 'permission-denied') {
                           showMessage("Failed to mark trash can: Missing or insufficient Firestore permissions. Please check your Firebase Security Rules.", 'error');
                      } else {
                           showMessage(`Failed to mark trash can: ${error.message}`, 'error');
                      }
                  }
              } else {
                  showMessage('Geocoding failed: ' + status + '. Please check the address.', 'error');
              }
          });
      });

      // Handle route planning
      document.getElementById("plan-route-form").addEventListener("submit", async (event) => {
          event.preventDefault();
          const startInput = document.getElementById("route-start").value.trim();
          const endInput = document.getElementById("route-end").value.trim();
          const routeDisplay = document.getElementById("route-display");
          const routeDetailsText = document.getElementById("route-details-text");

          // Clear previous polyline routes
          mapPolylines.forEach((polyline) => polyline.setMap(null));
          mapPolylines = [];
          if (infoWindow) {
            infoWindow.close(); // Close any open info window
          }

          let startCoords = null,
            endCoords = null;

          // Function to geocode an address/ID and return coordinates
          const getCoords = (input, isStart = true) =>
            new Promise(async (resolve, reject) => {
              if (input.toLowerCase() === "my location") {
                // Simulate current location as map center
                // Attempt to get actual geolocation if available
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            resolve({ lat: position.coords.latitude, lng: position.coords.longitude });
                        },
                        (error) => {
                            console.warn("Geolocation failed, using map center:", error);
                            resolve(map.getCenter()); // Fallback to map center
                        }
                    );
                } else {
                    resolve(map.getCenter()); // Fallback if geolocation not supported
                }
              } else if (input.toLowerCase().startsWith("trash can id:")) {
                const canId = input.substring("trash can id:".length).trim();
                const targetCan = trashCans.find((can) => can.id === canId);
                if (targetCan) {
                  resolve({ lat: targetCan.latitude, lng: targetCan.longitude });
                  if (!isStart) trackVisitedCan(canId); // Track if it's the end point
                } else {
                  reject("Trash Can ID not found.");
                }
              } else {
                // Assume it's lat,lon directly
                const parts = input.split(",").map((p) => parseFloat(p.trim()));
                if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                  resolve({ lat: parts[0], lng: parts[1] });
                } else {
                  // Attempt geocoding if not direct coordinates
                  geocoder.geocode({ address: input }, (results, status) => {
                    if (status === "OK" && results[0]) {
                      resolve(results[0].geometry.location);
                    } else {
                      reject(`Geocoding failed for "${input}": ${status}`);
                    }
                  });
                }
              }
            });

          try {
            startCoords = await getCoords(startInput, true);
            endCoords = await getCoords(endInput, false);
          } catch (error) {
            showMessage(`Error getting coordinates: ${error}`, "error");
            return;
          }

          const preferredUnits = currentUserData?.preferredUnits || 'km';
          let distance = calculateDistance(
            startCoords.lat(),
            startCoords.lng(),
            endCoords.lat(),
            endCoords.lng(),
            preferredUnits
          );

          const routeInstructions = `Walk ${distance.toFixed(
            2
          )} ${preferredUnits}. Start at Lat: ${startCoords.lat().toFixed(
            4
          )}, Lon: ${startCoords.lng().toFixed(4)}. End at Lat: ${endCoords
            .lat()
            .toFixed(4)}, Lon: ${endCoords.lng().toFixed(4)}.`;

          routeDetailsText.textContent = routeInstructions;
          routeDisplay.classList.remove("hidden");

          // Update user's total distance walked and recent routes
          if (currentUserData) {
            const userDocRef = doc(
              db,
              `artifacts/${appId}/users/${userId}/profile`,
              "data"
            );
            const updatedTotalDistance = (currentUserData.totalDistanceWalked || 0) + distance;
            const updatedRecentRoutes = [{
                start: startInput,
                end: endInput,
                distance: parseFloat(distance.toFixed(2)),
                units: preferredUnits,
                timestamp: serverTimestamp()
            }, ...(currentUserData?.recentRoutes || [])].slice(0, 3); // Keep last 3 routes

            await updateDoc(userDocRef, {
              totalDistanceWalked: updatedTotalDistance,
              recentRoutes: updatedRecentRoutes
            });
          }

          // Draw polyline on the map
          const routePath = new google.maps.Polyline({
            path: [startCoords, endCoords],
            geodesic: true,
            strokeColor: "#3b82f6", // blue-500
            strokeOpacity: 0.8,
            strokeWeight: 4,
            map: map,
          });
          mapPolylines.push(routePath); // Store for clearing later

          // Fit map to route bounds
          const bounds = new google.maps.LatLngBounds();
          bounds.extend(startCoords);
          bounds.extend(endCoords);
          map.fitBounds(bounds);
          map.setZoom(Math.min(map.getZoom(), currentUserData?.defaultMapZoom || 15)); // Don't zoom too close if points are far

          showMessage("Route planned!", "success");
        }
      );

      // Simple Haversine distance calculation (approximation)
      function calculateDistance(lat1, lon1, lat2, lon2, units = 'km') {
        const R_km = 6371; // Radius of Earth in kilometers
        const R_mi = 3958.8; // Radius of Earth in miles
        const R = units === 'mi' ? R_mi : R_km;

        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c; // Distance in km or miles
      }

      // Track a visited trash can
      async function trackVisitedCan(canId) {
        if (!currentUserData) return;

        const userDocRef = doc(
          db,
          `artifacts/${appId}/users/${userId}/profile`,
          "data"
        );

        // Update visitedTrashCans (unique list)
        const visitedCans = new Set(currentUserData.visitedTrashCans || []);
        if (!visitedCans.has(canId)) {
          visitedCans.add(canId);
          await updateDoc(userDocRef, {
            visitedTrashCans: Array.from(visitedCans),
          });
          showMessage(`You visited a new trash can! ID: ${canId}`, "info");
        }

        // Update frequentedTrashCans (count for each can)
        const frequentedCans = currentUserData.frequentedTrashCans || {};
        frequentedCans[canId] = (frequentedCans[canId] || 0) + 1;
        await updateDoc(userDocRef, {
          frequentedTrashCans: frequentedCans,
        });

        checkAndAwardBadges(); // Re-check badges after update
      }

      // Add trash can to favorite locations
      window.addFavoriteLocation = async function(canId, canDescription) {
          if (!currentUserData || !userId) {
              showMessage("Please sign in to favorite locations.", "error");
              return;
          }
          const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'data');
          const currentFavorites = currentUserData.favoriteLocations || [];

          // Check if already favorited
          if (currentFavorites.some(fav => fav.id === canId)) {
              showMessage("This trash can is already in your favorites!", "info");
              return;
          }

          const newFavorite = { id: canId, description: canDescription, timestamp: serverTimestamp() };
          await updateDoc(userDocRef, {
              favoriteLocations: arrayUnion(newFavorite)
          });
          showMessage(`"${canDescription}" added to favorites!`, "success");
      }

      // Display user progress (distance, visited cans, marked cans, badges)
      function displayUserProgress() {
        if (!currentUserData) {
          document.getElementById("total-distance").textContent = "Loading...";
          document.getElementById("visited-cans-count").textContent = "Loading...";
          document.getElementById("marked-cans-count").textContent = "Loading...";
          document.getElementById("badges-display").innerHTML =
            '<p class="text-gray-500 italic">No badges earned yet. Keep exploring!</p>';
          recentSearchesList.innerHTML = '<p class="text-gray-500 italic text-sm">No recent searches.</p>';
          favoriteLocationsList.innerHTML = '<p class="text-gray-500 italic text-sm">No favorite locations.</p>';
          recentRoutesList.innerHTML = '<p class="text-gray-500 italic text-sm">No recent routes.</p>';
          return;
        }

        // Update Walking Metrics
        const totalDistance = currentUserData.totalDistanceWalked || 0;
        const preferredUnits = currentUserData.preferredUnits || 'km';
        document.getElementById("total-distance").textContent = `${totalDistance.toFixed(2)} ${preferredUnits}`;
        document.getElementById("visited-cans-count").textContent = (
          currentUserData.visitedTrashCans || []
        ).length;
        document.getElementById("marked-cans-count").textContent = (
          currentUserData.markedTrashCans || []
        ).length;

        // Update Badges Display
        const badgesDisplay = document.getElementById("badges-display");
        badgesDisplay.innerHTML = ""; // Clear previous badges

        if ((currentUserData.badges || []).length === 0) {
          badgesDisplay.innerHTML =
            '<p class="text-gray-500 italic">No badges earned yet. Keep exploring!</p>';
        } else {
          currentUserData.badges.forEach((badgeName) => {
            const badgeDiv = document.createElement("div");
            let badgeClass = "badge";
            if (badgeName.includes("Most Frequented")) badgeClass += " gold";
            else if (badgeName.includes("New Trash Cans Visited"))
              badgeClass += " silver";
            else if (badgeName.includes("New Trash Cans Marked"))
              badgeClass += " bronze";
            badgeDiv.className = badgeClass;
            badgeDiv.innerHTML = `<i data-lucide="award" class="mr-1 w-4 h-4"></i> ${badgeName}`;
            badgesDisplay.appendChild(badgeDiv);
          });
          lucide.createIcons(); // Re-render Lucide icons
        }

        // Update Recent Searches
        recentSearchesList.innerHTML = '';
        if ((currentUserData.recentSearches || []).length === 0) {
            recentSearchesList.innerHTML = '<p class="text-gray-500 italic text-sm">No recent searches.</p>';
        } else {
            currentUserData.recentSearches.forEach(search => {
                const li = document.createElement('li');
                li.textContent = search;
                recentSearchesList.appendChild(li);
            });
        }

        // Update Favorite Locations
        favoriteLocationsList.innerHTML = '';
        if ((currentUserData.favoriteLocations || []).length === 0) {
            favoriteLocationsList.innerHTML = '<p class="text-gray-500 italic text-sm">No favorite locations.</p>';
        } else {
            currentUserData.favoriteLocations.forEach(fav => {
                const li = document.createElement('li');
                li.textContent = `${fav.description} (ID: ${fav.id.substring(0,8)}...)`;
                favoriteLocationsList.appendChild(li);
            });
        }

        // Update Recent Routes
        recentRoutesList.innerHTML = '';
        if ((currentUserData.recentRoutes || []).length === 0) {
            recentRoutesList.innerHTML = '<p class="text-gray-500 italic text-sm">No recent routes.</p>';
        } else {
            currentUserData.recentRoutes.forEach(route => {
                const li = document.createElement('li');
                const timestamp = route.timestamp ? new Date(route.timestamp.seconds * 1000).toLocaleDateString() : 'N/A';
                li.textContent = `${route.start} to ${route.end} (${route.distance} ${route.units}) - ${timestamp}`;
                recentRoutesList.appendChild(li);
            });
        }
      }

      // Update settings UI elements based on currentUserData
      function updateSettingsUI() {
          if (currentUserData) {
              preferredUnitsSelect.value = currentUserData.preferredUnits || 'km';
              defaultMapZoomInput.value = currentUserData.defaultMapZoom || 12;
              notificationsEnabledCheckbox.checked = currentUserData.notificationsEnabled !== undefined ? currentUserData.notificationsEnabled : true;
          }
      }

      // Event listeners for settings changes
      preferredUnitsSelect.addEventListener('change', async () => {
          if (userId) {
              const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'data');
              await updateDoc(userDocRef, { preferredUnits: preferredUnitsSelect.value });
              showMessage('Preferred units updated!', 'success');
          }
      });

      defaultMapZoomInput.addEventListener('change', async () => {
          if (userId) {
              const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'data');
              const newZoom = parseInt(defaultMapZoomInput.value);
              if (!isNaN(newZoom) && newZoom >=1 && newZoom <= 20) {
                  await updateDoc(userDocRef, { defaultMapZoom: newZoom });
                  showMessage('Default map zoom updated!', 'success');
                  if (map) { // Update map zoom immediately if map is initialized
                      map.setZoom(newZoom);
                  }
              } else {
                  showMessage('Invalid zoom level. Please enter a number between 1 and 20.', 'error');
              }
          }
      });

      notificationsEnabledCheckbox.addEventListener('change', async () => {
          if (userId) {
              const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'data');
              await updateDoc(userDocRef, { notificationsEnabled: notificationsEnabledCheckbox.checked });
              showMessage(`Notifications ${notificationsEnabledCheckbox.checked ? 'enabled' : 'disabled'}!`, 'success');
          }
      });


      // Logic for awarding badges
      async function checkAndAwardBadges() {
        if (!currentUserData) return;

        const userDocRef = doc(
          db,
          `artifacts/${appId}/users/${userId}/profile`,
          "data"
        );
        let updatedBadges = new Set(currentUserData.badges || []);
        let badgesAwarded = false;

        // "New Trash Cans Visited" (3 unique cans)
        if (
          (currentUserData.visitedTrashCans || []).length >= 3 &&
          !updatedBadges.has("New Trash Cans Visited")
        ) {
          updatedBadges.add("New Trash Cans Visited");
          showMessage(
            'Congratulations! You earned "New Trash Cans Visited" badge!',
            "success"
          );
          badgesAwarded = true;
        }

        // "Trash Can Most Frequented" (Visit any can 5 times)
        const frequentedCans = currentUserData.frequentedTrashCans || {};
        const hasFrequentedBadge = Object.values(frequentedCans).some(
          (count) => count >= 5
        );
        if (hasFrequentedBadge && !updatedBadges.has("Trash Can Most Frequented")) {
          updatedBadges.add("Trash Can Most Frequented"); // Fixed typo in badge name
          showMessage(
            'Amazing! You earned "Trash Can Most Frequented" badge!',
            "success"
          );
          badgesAwarded = true;
        }

        // "New Trash Cans Marked" (Mark 1 new can)
        if (
          (currentUserData.markedTrashCans || []).length >= 1 &&
          !updatedBadges.has("New Trash Cans Marked")
        ) {
          updatedBadges.add("New Trash Cans Marked");
          showMessage(
            'Great job! You earned "New Trash Cans Marked" badge!',
            "success"
          );
          badgesAwarded = true;
        }

        if (badgesAwarded) {
          await updateDoc(userDocRef, {
            badges: Array.from(updatedBadges),
          });
        }
      }

      // Handle general chat message sending
      document
        .getElementById("send-general-message-btn")
        .addEventListener("click", async () => {
          const chatInput = document.getElementById("general-chat-input");
          const message = chatInput.value.trim();

          if (!message) {
            showMessage("Message cannot be empty.", "error");
            return;
          }

          try {
            await addDoc(
              collection(db, `artifacts/${appId}/public/data/general_chat`),
              {
                userId: userId,
                userDisplayName: userDisplayName,
                message: message,
                timestamp: serverTimestamp(),
              }
            );
            chatInput.value = ""; // Clear input
          } catch (error) {
            console.error("Error sending general message:", error);
            if (error.code === "permission-denied") {
              showMessage(
                "Failed to send message: Missing or insufficient Firestore permissions. Please check your Firebase Security Rules.",
                "error"
              );
            } else {
              showMessage(`Failed to send message: ${error.message}`, "error");
            }
          }
        });

      // Handle specific chat message sending
      document
        .getElementById("send-specific-message-btn")
        .addEventListener("click", async () => {
          if (!currentSelectedCanId) {
            showMessage("Please select a trash can to chat about first.", "error");
            return;
          }

          const chatInput = document.getElementById("specific-chat-input");
          const message = chatInput.value.trim();

          if (!message) {
            showMessage("Message cannot be empty.", "error");
            return;
          }

          try {
            // Path: artifacts/{appId}/public/data/trash_cans/{canId}/can_chats
            await addDoc(
              collection(
                db,
                `artifacts/${appId}/public/data/trash_cans/${currentSelectedCanId}/can_chats`
              ),
              {
                userId: userId,
                userDisplayName: userDisplayName,
                message: message,
                timestamp: serverTimestamp(),
              }
            );
            chatInput.value = ""; // Clear input
          } catch (error) {
            console.error(`Error sending message for can ${currentSelectedCanId}:`, error);
            if (error.code === "permission-denied") {
              showMessage(
                "Failed to send message for this can: Missing or insufficient Firestore permissions. Please check your Firebase Security Rules.",
                "error"
              );
            } else {
              showMessage(
                `Failed to send message for this can: ${error.message}`,
                "error"
              );
            }
          }
        });

      // Function to select a trash can and load its specific chat
      window.selectTrashCanForChat = function (canId) {
        // Made global for onclick in info window
        currentSelectedCanId = canId;
        document.getElementById("specific-chat-can-id").textContent =
          canId.substring(0, 8) + "...";
        document.getElementById("specific-chat-section").classList.remove("hidden");

        // Set up a listener for this specific trash can's chat
        const specificChatColRef = collection(
          db,
          `artifacts/${appId}/public/data/trash_cans/${canId}/can_chats`
        );
        const specificChatQuery = query(specificChatColRef);

        // Detach previous specific chat listener if any (important for memory)
        if (window.currentSpecificChatUnsubscribe) {
          window.currentSpecificChatUnsubscribe();
        }

        window.currentSpecificChatUnsubscribe = onSnapshot(
          specificChatQuery,
          (snapshot) => {
            specificChatMessages = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            displayChatMessages("specific");
            console.log(`Specific chat for ${canId} updated:`, specificChatMessages);
          },
          (error) => {
            console.error(`Error fetching specific chat for ${canId}:`, error);
            if (error.code === "permission-denied") {
              showMessage(
                `Error loading chat for can ${canId}: Missing or insufficient Firestore permissions. Please check your Firebase Security Rules.`,
                "error"
              );
            } else {
              showMessage(
                `Error loading chat for can ${canId}: ${error.message}`,
                "error"
              );
            }
          }
        );

        // Switch to chat tab if not already there
        showTab("chat");
        document.getElementById("general-chat-messages").style.minHeight = "150px"; // Adjust height for two chat sections
      };

      // --- Camera and Photo Functionality ---
      const cameraFeed = document.getElementById("camera-feed");
      const photoCanvas = document.getElementById("photo-canvas");
      const photoPreview = document.getElementById("photo-preview");
      // const cameraPlaceholderText = document.getElementById("camera-placeholder-text"); // Removed from HTML
      const startCameraBtn = document.getElementById("start-camera-btn");
      const takePhotoBtn = document.getElementById("take-photo-btn");
      const uploadPhotoInput = document.getElementById("upload-photo-input");
      const uploadPhotoBtn = document.getElementById("upload-photo-btn");
      const context = photoCanvas.getContext("2d");

      startCameraBtn.addEventListener("click", async () => {
        try {
          if (mediaStream) {
            // If camera is already active, stop it
            mediaStream.getTracks().forEach((track) => track.stop());
            mediaStream = null;
            startCameraBtn.textContent = "Activate Camera";
            takePhotoBtn.classList.add("hidden");
            takePhotoBtn.disabled = true;
            capturedPhotoBase64 = null;
            showMessage("Camera stopped.", "info");
            return; // Exit if stopping camera
          }
          mediaStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" },
          }); // Prefer rear camera
          cameraFeed.srcObject = mediaStream;
          cameraFeed.classList.remove("hidden"); // Keep hidden, it's just for capturing
          photoPreview.classList.add("hidden");
          // cameraPlaceholderText.classList.add("hidden"); // Removed from HTML
          takePhotoBtn.classList.remove("hidden");
          takePhotoBtn.disabled = false;
          startCameraBtn.textContent = "Stop Camera"; // Change button text
          showMessage("Camera activated! Click 'Take Photo' to capture.", "success");
        } catch (err) {
          console.error("Error accessing camera:", err);
          showMessage(
            "Could not access camera. Please ensure permissions are granted.",
            "error"
          );
          takePhotoBtn.disabled = true;
        }
      });

      takePhotoBtn.addEventListener("click", () => {
        if (mediaStream) {
          photoCanvas.width = cameraFeed.videoWidth;
          photoCanvas.height = cameraFeed.videoHeight;
          context.drawImage(cameraFeed, 0, 0, photoCanvas.width, photoCanvas.height);
          capturedPhotoBase64 = photoCanvas.toDataURL("image/png"); // Get image as Base64
          // photoPreview.src = capturedPhotoBase64; // No longer displaying preview
          // photoPreview.classList.remove("hidden"); // No longer displaying preview
          cameraFeed.classList.add("hidden"); // Hide camera feed after capture
          // cameraPlaceholderText.classList.add("hidden"); // Removed from HTML
          showMessage("Photo captured! It will be attached to the trash can.", "success");
          // Stop camera after taking photo
          if (mediaStream) {
            mediaStream.getTracks().forEach((track) => track.stop());
            mediaStream = null;
            startCameraBtn.textContent = "Activate Camera";
            takePhotoBtn.classList.add("hidden");
            takePhotoBtn.disabled = true;
          }
        } else {
          showMessage("No camera stream active to take a photo.", "error");
        }
      });

      uploadPhotoBtn.addEventListener("click", () => {
        uploadPhotoInput.click(); // Trigger file input click
      });

      uploadPhotoInput.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            capturedPhotoBase64 = e.target.result;
            // photoPreview.src = capturedPhotoBase64; // No longer displaying preview
            // photoPreview.classList.remove("hidden"); // No longer displaying preview
            cameraFeed.classList.add("hidden"); // Ensure camera feed is hidden
            // cameraPlaceholderText.classList.add("hidden"); // Removed from HTML
            takePhotoBtn.classList.add("hidden"); // Hide take photo button for uploaded image
            takePhotoBtn.disabled = true;
            if (mediaStream) {
              // Stop camera if active
              mediaStream.getTracks().forEach((track) => track.stop());
              mediaStream = null;
              startCameraBtn.textContent = "Activate Camera";
            }
            showMessage("Photo uploaded! It will be attached to the trash can.", "success");
          };
          reader.readAsDataURL(file);
        }
      });

      // Function to reset camera and photo functionality state
      function resetCameraAndPhotoPreview() {
        if (mediaStream) {
          mediaStream.getTracks().forEach((track) => track.stop());
          mediaStream = null;
        }
        cameraFeed.classList.add("hidden");
        photoCanvas.classList.add("hidden");
        photoPreview.classList.add("hidden");
        // cameraPlaceholderText.classList.remove("hidden"); // Removed from HTML
        startCameraBtn.textContent = "Activate Camera";
        takePhotoBtn.classList.add("hidden");
        takePhotoBtn.disabled = true;
        capturedPhotoBase64 = null;
        uploadPhotoInput.value = ''; // Clear file input
      }


      // Tab switching logic
      window.showTab = function (tabId) {
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.add("hidden");
        });

        const headerTrashIcon = document.getElementById("header-trash-icon");
        // Remove all specific text color classes from the icon
        headerTrashIcon.classList.remove(
          "text-blue-700",
          "text-red-600",
          "text-green-600",
          "text-amber-500"
        );

        document.querySelectorAll(".tab-button").forEach((button) => {
          // Remove 'active' and all custom color classes
          button.classList.remove("active", "blue", "red", "green", "yellow");
        });

        // Remove all specific color classes from ALL btn-primary elements, EXCEPT 'purple'
        document.querySelectorAll(".btn-primary").forEach((btn) => {
          btn.classList.remove("blue", "red", "green", "yellow");
        });

        const activeTabButton = document.getElementById(`tab-${tabId}`);
        activeTabButton.classList.add("active"); // Add default active class

        // Apply specific colors based on tabId
        if (tabId === "map") {
          activeTabButton.classList.add("blue"); // Add blue class to the tab button itself
          headerTrashIcon.classList.add("text-blue-700");
          // Apply blue to buttons within this tab
          document
            .querySelectorAll("#content-map .btn-primary")
            .forEach((btn) => btn.classList.add("blue"));
        } else if (tabId === "mark-can") {
          activeTabButton.classList.add("red");
          headerTrashIcon.classList.add("text-red-600");
          // Apply red to buttons within this tab
          document
            .querySelectorAll("#content-mark-can .btn-primary")
            .forEach((btn) => btn.classList.add("red"));
        } else if (tabId === "chat") {
          activeTabButton.classList.add("green");
          headerTrashIcon.classList.add("text-green-600"); /* Use green-600 for consistency */
          // Apply green to buttons within this tab
          document
            .querySelectorAll("#content-chat .btn-primary")
            .forEach((btn) => btn.classList.add("green"));
        } else if (tabId === "progress") {
          activeTabButton.classList.add("yellow");
          headerTrashIcon.classList.add("text-amber-500"); /* Use amber-500 for yellow */
          // My Progress tab does not have dynamic buttons that need recoloring.
        }

        document.getElementById(`content-${tabId}`).classList.remove("hidden");

        // Special handling for map and chat tabs to ensure correct rendering/sizing
        if (tabId === "chat") {
          if (
            document
              .getElementById("specific-chat-section")
              .classList.contains("hidden")
          ) {
            document.getElementById("general-chat-messages").style.minHeight =
              "300px";
          }
        } else if (tabId === "map") {
          // Trigger map resize event to ensure it renders correctly after being hidden/shown
          if (mapInitialized && map) { // Only interact with map if it's initialized
            google.maps.event.trigger(map, "resize");
            // Recenter map if there are trash cans, otherwise use default
            if (trashCans.length > 0) {
              const bounds = new google.maps.LatLngBounds();
              trashCans.forEach((can) =>
                bounds.extend({ lat: can.latitude, lng: can.longitude })
              );
              map.fitBounds(bounds);
              map.setZoom(Math.min(map.getZoom(), currentUserData?.defaultMapZoom || 15)); // Adjust zoom level
            } else {
              map.setCenter({ lat: 34.0522, lng: -118.2437 }); // Default center (e.g., LA)
              map.setZoom(currentUserData?.defaultMapZoom || 12);
            }
          } else {
              console.warn("Map not yet initialized when trying to show map tab.");
          }
        }
        // Re-render Lucide icons for the newly active tab
        lucide.createIcons();
      };

      // Initialize the app on window load (Firebase will initialize before map callback if defer)
      window.onload = initializeFirebaseApp;

      // Call lucide.createIcons() immediately after the DOM is loaded
      // This ensures all initial icons are rendered without waiting for Firebase or other async ops.
      document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
      });
    </script>
  </body>
</html>
